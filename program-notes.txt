General

Message transmission is optimized to reach the receiver module on the shortest route. I.e. messages that need to reach KOMBI are sent on KCAN even if the BMW implementation would have sent it over PTCAN. This is done to minimize any gateway (JBE) delay.
Functions that make use of CANID 0x6F1 (iDrive volume, SVT_70 gateway) are deactivated if communication on the DCAN from an OBD tool is detected.
Wherever pausing is required (dtc/dsc off for example), FiFo queues are implemented to ensure reading and processing of messages is unaffected.
To diagnose/code/etc. the SVT module, hold POWER when turning on ignition. Transmitting to DCAN corrupts UIF reads for other modules.


Arduino IDE settings

Board: Teensy 4.0
Optimize: Fastest
CPU Speed: 528 MHz
USB Type: Dual Serial for debugging, Single for normal operation.



General section

1.  Open the exhaust flap if MDrive is on with POWER set to Sport+.
2.  Check timeouts for suspended PT-CAN and iDrive diag transmission.
3.  Check the iDrive diag queue.
4.  Check Needle sweep animation transmission queue.
5.  Check Mirror fold transmission queue.
6.  Monitor the CPU temperature and adjust clock speed accordingly.
7.  Check the DSC transmission queue.
8.  Enable the use of M3 center console button block. POWER and DSC OFF buttons. Control POWER LED.
     POWER controls the DME throttle map. Holding POWER during ignition cycling enables diagnosis of the SVT70.
     Request full DSC OFF after holding DSC OFF button. Turn everything back on with a short press.
9.  Send MDrive alive message to the network. This fully replaces the 0x399 MDrive status allowing control of:
     EDC
     DSC
     DME throttle map
     Servotronic via SVT70 module
10. Check seat heating transmission queues.
11. Check Reverse beep transmission queue.
12. Check MSA and HDC Check Control queue.
13. Monitor sleep state timeout. Reset runtime variables if the car falls asleep.



K-CAN section

1.  Monitor throttle, RPM and clutch status. This is used buy the shift lights, exhaust flap and launch control indicator code.
2.  Monitor the state of cruise control, HDC and MSA button.
     Create a HDC function similar to the one in xDrive cars to get rid of that pesky blank button.
     Display a CC when pressing the Auto Start-stop button. N54 cars never had this option. Again, we would like to get rid of that pesky blank button.
3.  Check if the vehicle is moving and how fast.
4.  Check the state of the indicators. Dim the corresponding DRL when on.
5.  Monitor and indicate front foglight status. Monitor DRL status.
6.  Turn on driver's and passenger's seat heating when ignition is turned on and ambient temperature is below configured threshold.
7.  Receive POWER CKM setting from iDrive.
8.  Monitor reverse gear status and transmit a short beep when engaged.
9.  Receive EDC CKM setting from iDrive.
10. Receive, save and update MDrive settings from iDrive.
11. Monitor the state of the front doors to update audio volume.
12. Change audio volume when doors are opened/closed.
13. Monitor ignition status. Send corresponding DME and SVT power modes.
14. Monitor remote number and button status.
15. Monitor ambient temperature.
16. Monitor passenger's seat status. Seatbelt and occupancy sensor.
17. Update the car clock from Teensy's RTC if power is lost.
18. Track time and date settings from iDrive and save in Teensy's RTC.
19. Send DME POWER CKM (car key memory) message.
20. Track battery voltage (debug only) and Engine On status.
21. Monitor EDC CKM status sent by the JBE. Correct if it doesn't match the saved EEPROM value.
22. Create the two missing messages required to use an F series ZBE (KCAN1, not KCAN2) in an E6,7,8,9X car.
   *Should* work with:
    6582 9267955 - 4-pin MEDIA button. **Tested - controller build date 19.04.13
    6131 9253944 - 4-pin CD button
    6582 9206444 - 10-pin CD button
    6582 9212449 - 10-pin CD button
23. Monitor FRM status response for mirror fold status.

Credit to Trevor for providing insight into 0x273, 0x277, 0x2CA and 0x0AA http://www.loopybunny.co.uk/CarPC/k_can.html



PT-CAN section

1. Monitor steering wheel buttons and request MDrive when Source/M is pressed.
   Holding the M button for about 2s brings up the MDrive settings in iDrive.
2. Monitor and indicate FTM status in KOMBI by flashing tyre icon when initializing.
3. Monitor and align shiftlights with the variable redline request from the DME.
4. Forwards any diagnostic messages sent by the SVT70 module on the PT-CAN to the D-CAN to enable communication with BMW tools. In the E70 this is implemented in the JBE gateway tables.
5. Forward CC (check control) notifications from the SVT70 to KCAN so that KOMBI can display them.



DCAN section

1. Forward any messages sent by the DCAN tool to the PT-CAN to enable communication with the SVT70.
2. Receive volume data from iDrive.
3. Monitor bus for communication and suspend 0x6F1 KWP transmissions if an OBD tool is detected.



MSD81 IKM0S binary modification

[PROGRAM]

0x83738   and  0x83739  -> 1F 03      CAN message table
0x1F3AD4  and  0x1F3AD5 -> 1F 03      CAN filters

Replace 15 03 (0x315 represented in Little Endian) to stop MSD81 from reacting to Vehicle Mode changes (triggered by JBBF through EDC button)
This also allows state_spt (throttle map) to be controlled independently from the main "MDrive" with the console switch.
Re-calculate checksum at 0x80304 using csprogram-windows.exe


[MAP]

lc_var_spt_swi at 0x4CD1D set to 00. This disables the DME 1M MDrive logic. 0x399, 0x1D9 etc.
By default the DME hard-codes the MDrive values for Servotronic, EDC etc. In order to replace them, these functions need to be disabled.
