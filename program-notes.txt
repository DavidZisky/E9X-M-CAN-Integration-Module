General

Message transmission is optimized to reach the receiver module on the shortest route. I.e. messages that need to reach KOMBI are sent on KCAN even if the BMW implementation would have sent it over PTCAN. This is done to minimize any gateway (JBE) delay.
Functions that make use of CANID 0x6F1 (iDrive volume, SVT_70 gateway) are deactivated if communication on the DCAN from an OBD tool is detected.
Wherever pausing is required (dtc/dsc off for example), FiFo queues are implemented to ensure reading and processing of messages is unaffected.
To diagnose/code/etc. the SVT module, hold POWER when turning on ignition. Transmitting to DCAN corrupts UIF reads for other modules.


Arduino IDE settings

Board: Teensy 4.0
Optimize: Fastest
CPU Speed: 528 MHz
USB Type: Dual Serial for debugging, Single for normal operation.



General section

Enable the use of M3 centre console button block. POWER and DSC OFF buttons. Control POWER LED.
1. Request MDrive when POWER button is pressed.
2. Illuminate POWER LED when throttle sport mode is on.
3. Request full DSC OFF after holding DSC OFF button. Turn everything back on with a short press.
4. Display Launch control flag
5. Create missing 0x206 message to animate DCT KOMBI shift lights.



K-CAN section

1.  Monitor throttle, RPM and clutch status to control the shift lights and exhaust flap.
2.  Monitor the state of the front doors.
3.  Monitor ignition and DSC program status.
4.  Transmit DME and SVT70 mode requests.
5.  Monitor and indicate front foglight status.
6.  Track time and date settings from iDrive and save in RTC.
7.  Turn on driver's and passenger's seat heating when ignition is turned on and ambient temperature is below configured threshold.
8.  Update the car clock from Teensy's RTC if power is lost.
9.  Send DME POWER CKM (car key memory) message.
10. Track battery voltage (debug only) and Engine On status.
11. Receive, save and update MDrive settings from iDrive.
12. Fully replaces the 0x399 MDrive status allowing control of:
    EDC
    DSC
    DME throttle map
    Servotronic via SVT70 module
13. Create the two missing messages required to use an F series ZBE (KCAN1, not KCAN2) in an E6,7,8,9X car.
   *Should* work with:
    6582 9267955 - 4-pin MEDIA button. **Tested - controller build date 19.04.13
    6131 9253944 - 4-pin CD button
    6582 9206444 - 10-pin CD button
    6582 9212449 - 10-pin CD button
14. Change audio volume when doors are opened/closed.

Credit to Trevor for providing insight into 0x273, 0x277, 0x2CA and 0x0AA http://www.loopybunny.co.uk/CarPC/k_can.html



PT-CAN section

1. Monitor steering wheel buttons and request MDrive when Source/M is pressed.
2. Monitor and indicate FTM status in KOMBI by flashing tyre icon when initializing.
3. Monitor and align shiftlights with the variable redline request from the DME.
4. Forwards any diagnostic messages sent by the SVT70 module on the PT-CAN to the D-CAN to enable communication with BMW tools. In the E70 this is implemented in the JBE gateway tables.
5. Forward CC (check control) notifications from the SVT70 to KCAN so that KOMBI can display them.



DCAN section

1. Forward any messages sent by the DCAN tool to the PT-CAN to enable communication with the SVT70.
2. Receive volume data from iDrive.
3. Monitor bus for communication and suspend 0x6F1 transmissions if an OBD tool is detected.



MSD81 IKM0S binary modification

[PROGRAM]

0x83738   and  0x83739  -> F1 07      CAN message table
0x1F3AD4  and  0x1F3AD5 -> F1 07      CAN filters

Replace 15 03 (0x315 represented in Little Endian) to stop MSD81 from reacting to Vehicle Mode changes (triggered by JBBF through EDC button)
This also allows state_spt (throttle map) to be controlled independently from the main "MDrive" with the console switch.
Re-calculate checksum at 0x80304 using csprogram-windows.exe


[MAP]

lc_var_spt_swi at 0x4CD1D set to 00. This disables the DME 1M MDrive logic. 0x399, 0x1D9 etc.
By default the DME hard-codes the MDrive values for Servotronic, EDC etc. In order to replace them, these functions need to be disabled.
